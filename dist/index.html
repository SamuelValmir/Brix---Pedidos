<!-- I must:
    bootstrap button effects
    colors
    select column and start point line
    background animations (balls moving)
-->

<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <!-- Bootstrap CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-pprn3073KE6tl6bjs2QrFaJGz5/SUsLqktiwsUTF55Jfv3qYSDhgCecCxMW52nD2"
        crossorigin="anonymous"></script>

    <!-- Script to read excel files (CDN)-->
    <script src="https://unpkg.com/read-excel-file@5.x/bundle/read-excel-file.min.js"></script>

    <!-- Jquery CDN -->
    <script src="https://code.jquery.com/jquery-3.6.0.slim.min.js"
        integrity="sha256-u7e5khyithlIdTpu22PHhENmPcRdFiHRjhAuHcs05RI=" crossorigin="anonymous"></script>

    <link rel="stylesheet" href="./css/style.css">
    <title>Pedidos</title>
</head>

<body>
    <div class="container-fluid p-5">
        <div class="d-flex justify-content-center">
            <input class="form-control mb-4 " type="file"
                accept=".xlsx, .xlsm, .xlsb, .xlsb, .xlsx, .xltx, .xltm, .xls, .xlt, .xml, .xlam, .xla, .xlw, .xlr"
                id="file" name="formattedTable">
        </div>

        <div class="d-flex flex-column align-items-center visually-hidden" id="settingsButtons">
            <p>Selecione as colunas e linhas que deseja excluir</p>
            <button class="btn btn-primary mb-2" onclick="" data-bs-toggle="tooltip" data-bs-placement="bottom"
                title="Serão selecionados como elementos da coluna A a coluna F incluindo a coluna L (estado
            CE), a partir da linha 7
            (Se essas opções não estiverem de acordo com os dados da tabela, opte por selecionar os elementos manualmente)">
                Selecionar automaticamente </button>

            <button class="btn btn-primary mb-5" onclick="saveFile()">Salvar Planilha</button>
        </div>


        <div style="display:none">
            (dialog box)
            Confirme que deseja gerar uma nova planilha.
            Confirmar Cancelar

            Deseja manter essas configurações?
            Manter Mudar configurações de geração

            Depois de salvo os dados não selecionados serão permanentemente excluídos. Deseja prosseguir?
            voltar confirmar


            Gerando
        </div>

        <!-- <div class="w-75 overflow-auto"> -->
        <div class="table-responsive">
            <table class="table table-striped-columns table-hover table-bordered">
            </table>
        </div>

    </div>

    <div class="bg-dark w-100 h-100 position-absolute top-0 bg-opacity-50 d-flex justify-content-center align-items-center flex-column visually-hidden"
        id="loader-container">
        <div class="spinner-border text-primary fs-1" id="loader"></div>
        <div class="text-light pt-5 fs-2">Carregando Documento</div>
    </div>

    <script src="js/table.js"></script>

    <script>
        // Allow use tooltip
        const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
        const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))

        const inputFile = document.querySelector("#file");
        const file = inputFile.files[0];

        inputFile.addEventListener("change", () => tryShowTableOnPage());

        function tryShowTableOnPage() {
            let fileElement = document.getElementById("file");
            const extensionPosition = fileElement.value.lastIndexOf(".");
            const fileExtension = fileElement.value.substring(extensionPosition);
            const acceptExtensions = fileElement.getAttribute("accept").split(",");

            if (acceptExtensions.includes(fileExtension.toLowerCase())) {
                showTableOnPage();
            } else if (fileExtension !== "") {
                fileElement.value = "";
                alert(`O arquivo de extensão ${fileExtension} não é válido.\nPor favor, selecione um arquivo com um dos seguintes formatos:\n\n${acceptExtensions}`)
            }
        };

        async function showTableOnPage() {
            tableHead.innerHTML = "";
            tableBody.innerHTML = "";
            showLoaderScreen();
            disableScroll();

            await readXlsxFile(inputFile.files[0])
                .then(rows => writeTable(rows));

            document.querySelector("#settingsButtons").classList.remove("visually-hidden");
            hideLoaderScreen();
            enableScroll();
        };

        function saveFile() {
            const json = tableToJson();
            // console.log(checkboxList);
            console.log(json);
            //  console.log(checkboxList)
            // sendFileToServer(json);

        };

        function tableToJson() {
            const jsonObject = {};
            let tableBody = document.querySelector("tbody").children;

            [...tableBody].forEach((row, rowIndex) => {
                jsonObject[rowIndex] = [];

                [...row.children].forEach(cell => {
                    if (cell.tagName.toLowerCase() === "td") {
                        jsonObject[rowIndex].push(cell.innerText);
                    };
                });
            });

            return jsonObject;
        };
    </script>

</body>

</html>